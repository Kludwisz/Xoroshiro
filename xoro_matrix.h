#pragma once
#include "xoroshiro.h"
#include "inttypes.h"

#define ONLY_TOP_BIT (0x8000000000000000ULL)

// hacky way to turn off warnings and still be able to compile
// the code just fine even without 128-bit int support
#ifndef __SIZEOF_INT128__
#define __int128 int
#endif
typedef unsigned __int128 uint128_t;

// structures for the fast xoroshiro transform
// matrix multiplication procedure

typedef struct FXTMatrix FXTMatrix;
struct FXTMatrix {
    uint64_t M[2][2][64];
};

typedef struct XMatrix XMatrix;
struct XMatrix {
    uint128_t M[128];
};

// ------------------------------------------------------------------------------------



void transposeFXTM(const FXTMatrix *matrix, FXTMatrix *transposed);
void multiplyFXTM(const FXTMatrix *a, const FXTMatrix *bT, FXTMatrix *c);
void fastXoroMatrixPower(const FXTMatrix *matrix, uint64_t power, FXTMatrix *result);
void fastXoroMatrixPower128(const FXTMatrix *matrix, uint64_t powerUpper64, uint64_t powerLower64, FXTMatrix *result);
void advanceXoroshiroFXTM(Xoroshiro *state, const FXTMatrix *fxtm);

// -------------------------------------------------------------------------------------

static const FXTMatrix XOROSHIRO_STANDARD_FXTM = {{
    {
        {
        9223653511831486464ULL,
        4611826755915743232ULL,
        2305913377957871616ULL,
        1152956688978935808ULL,
        576478344489467904ULL,
        288239172244733952ULL,
        144119586122366976ULL,
        72059793061183488ULL,
        36029896530591744ULL,
        18014948265295872ULL,
        9007474132647936ULL,
        4503737066323968ULL,
        2251868533161984ULL,
        1125934266580992ULL,
        562967133290496ULL,
        281483566645248ULL,
        140741783322624ULL,
        70370891661312ULL,
        35185445830656ULL,
        17592722915328ULL,
        8796361457664ULL,
        9223376435035504640ULL,
        4611688217517752320ULL,
        2305844108758876160ULL,
        1152922054379438080ULL,
        576461027189719040ULL,
        288230513594859520ULL,
        144115256797429760ULL,
        72057628398714880ULL,
        36028814199357440ULL,
        18014407099678720ULL,
        9007203549839360ULL,
        4503601774919680ULL,
        2251800887459840ULL,
        1125900443729920ULL,
        562950221864960ULL,
        281475110932480ULL,
        140737555466240ULL,
        70368777733120ULL,
        35184388866560ULL,
        17592194433280ULL,
        8796097216640ULL,
        4398048608320ULL,
        2199024304160ULL,
        1099512152080ULL,
        549756076040ULL,
        274878038020ULL,
        137439019010ULL,
        68719509505ULL,
        9223372071214530560ULL,
        4611686035607265280ULL,
        2305843017803632640ULL,
        1152921508901816320ULL,
        576460754450908160ULL,
        288230377225454080ULL,
        144115188612727040ULL,
        72057594306363520ULL,
        36028797153181760ULL,
        18014398576590880ULL,
        9007199288295440ULL,
        4503599644147720ULL,
        2251799822073860ULL,
        1125899911036930ULL,
        562949955518465ULL
        },
        {
        134217728ULL,
        67108864ULL,
        33554432ULL,
        16777216ULL,
        8388608ULL,
        4194304ULL,
        2097152ULL,
        1048576ULL,
        524288ULL,
        262144ULL,
        131072ULL,
        65536ULL,
        32768ULL,
        16384ULL,
        8192ULL,
        4096ULL,
        2048ULL,
        1024ULL,
        512ULL,
        256ULL,
        128ULL,
        64ULL,
        32ULL,
        16ULL,
        8ULL,
        4ULL,
        2ULL,
        1ULL,
        9223372036854775808ULL,
        4611686018427387904ULL,
        2305843009213693952ULL,
        1152921504606846976ULL,
        576460752303423488ULL,
        288230376151711744ULL,
        144115188075855872ULL,
        72057594037927936ULL,
        36028797018963968ULL,
        18014398509481984ULL,
        9007199254740992ULL,
        4503599627370496ULL,
        2251799813685248ULL,
        1125899906842624ULL,
        562949953421312ULL,
        281474976710656ULL,
        140737488355328ULL,
        70368744177664ULL,
        35184372088832ULL,
        17592186044416ULL,
        8796093022208ULL,
        4398046511104ULL,
        2199023255552ULL,
        1099511627776ULL,
        549755813888ULL,
        274877906944ULL,
        137438953472ULL,
        68719476736ULL,
        34359738368ULL,
        17179869184ULL,
        8589934592ULL,
        4294967296ULL,
        2147483648ULL,
        1073741824ULL,
        536870912ULL,
        268435456ULL
        }
    },
    {
        {
        9223372036854775808ULL,
        4611686018427387904ULL,
        2305843009213693952ULL,
        1152921504606846976ULL,
        576460752303423488ULL,
        288230376151711744ULL,
        144115188075855872ULL,
        72057594037927936ULL,
        36028797018963968ULL,
        18014398509481984ULL,
        9007199254740992ULL,
        4503599627370496ULL,
        2251799813685248ULL,
        1125899906842624ULL,
        562949953421312ULL,
        281474976710656ULL,
        140737488355328ULL,
        70368744177664ULL,
        35184372088832ULL,
        17592186044416ULL,
        8796093022208ULL,
        9223376434901286912ULL,
        4611688217450643456ULL,
        2305844108725321728ULL,
        1152922054362660864ULL,
        576461027181330432ULL,
        288230513590665216ULL,
        144115256795332608ULL,
        72057628397666304ULL,
        36028814198833152ULL,
        18014407099416576ULL,
        9007203549708288ULL,
        4503601774854144ULL,
        2251800887427072ULL,
        1125900443713536ULL,
        562950221856768ULL,
        281475110928384ULL,
        140737555464192ULL,
        70368777732096ULL,
        35184388866048ULL,
        17592194433024ULL,
        8796097216512ULL,
        4398048608256ULL,
        2199024304128ULL,
        1099512152064ULL,
        549756076032ULL,
        274878038016ULL,
        137439019008ULL,
        68719509504ULL,
        34359754752ULL,
        17179877376ULL,
        8589938688ULL,
        4294969344ULL,
        2147484672ULL,
        1073742336ULL,
        536871168ULL,
        268435584ULL,
        134217792ULL,
        67108896ULL,
        33554448ULL,
        16777224ULL,
        8388612ULL,
        4194306ULL,
        2097153ULL
        },
        {
        134217728ULL,
        67108864ULL,
        33554432ULL,
        16777216ULL,
        8388608ULL,
        4194304ULL,
        2097152ULL,
        1048576ULL,
        524288ULL,
        262144ULL,
        131072ULL,
        65536ULL,
        32768ULL,
        16384ULL,
        8192ULL,
        4096ULL,
        2048ULL,
        1024ULL,
        512ULL,
        256ULL,
        128ULL,
        64ULL,
        32ULL,
        16ULL,
        8ULL,
        4ULL,
        2ULL,
        1ULL,
        9223372036854775808ULL,
        4611686018427387904ULL,
        2305843009213693952ULL,
        1152921504606846976ULL,
        576460752303423488ULL,
        288230376151711744ULL,
        144115188075855872ULL,
        72057594037927936ULL,
        36028797018963968ULL,
        18014398509481984ULL,
        9007199254740992ULL,
        4503599627370496ULL,
        2251799813685248ULL,
        1125899906842624ULL,
        562949953421312ULL,
        281474976710656ULL,
        140737488355328ULL,
        70368744177664ULL,
        35184372088832ULL,
        17592186044416ULL,
        8796093022208ULL,
        4398046511104ULL,
        2199023255552ULL,
        1099511627776ULL,
        549755813888ULL,
        274877906944ULL,
        137438953472ULL,
        68719476736ULL,
        34359738368ULL,
        17179869184ULL,
        8589934592ULL,
        4294967296ULL,
        2147483648ULL,
        1073741824ULL,
        536870912ULL,
        268435456ULL
        }
    }
}};
